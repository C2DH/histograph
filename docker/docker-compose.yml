version: '3.7'
services:
  neo4j:
    image: neo4j
    environment: 
      NEO4J_AUTH: neo4j/neo4jpwd
      # Memory configuration tweaks:
      # NEO4J_dbms_memory_heap_initial_size: 15g
      # NEO4J_dbms_memory_heap_max_size: 15g
      # NEO4J_dbms_memory_pagecache_size: 15g
    volumes:
      - ./data/neo4j:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  histograph:
    restart: always
    image: theorm/histograph
    environment:
      NODE_ENV: production
      PORT: 8000
    depends_on:
      - neo4j
    volumes:
      - ./data/histograph-contents:/histograph/contents
      - ./config/histograph.js:/histograph/settings.js
  nginx:
    restart: always
    image: nginx:1.17-alpine
    ports:
      - 80:80
      - 443:443
    depends_on:
      - histograph
      - iipsrv
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf
    command: [nginx-debug, '-g', 'daemon off;']
  iipsrv:
    restart: always
    image: theorm/iipsrv
    volumes:
      - ./data/iipsrv_images:/data/images
  histograph_init:
    restart: on-failure
    image: theorm/histograph
    entrypoint: /bin/sh -c "node scripts/init.js && node scripts/manage.js --task entity.jaccard --entity person"
    depends_on:
      - neo4j
    volumes:
      - ./data/histograph-contents:/histograph/contents
      - ./config/histograph.js:/histograph/settings.js
